<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css">
  <link rel="stylesheet" href="../style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>
  <title th:text="${companyName} + ' long term fundamentals'"></title>
</head>
<body>

<div th:replace="fragments/navbar :: my_fragment(active='Charts')"></div>
<div class="clearFloat"></div>

<div id="content">

  <h2><span id="stock" th:text="${stock}"></span><span id="stock-name"></span></h2> <a href="#" id="show-description-link">Show description</a>
  <div id="stock-description" class="hidden-element"></div>
  
  
  <div id="charts">
  
  </div>
  
  <h2>Checks</h2>
  <div id="flags">
  
  </div>
</div>

<script>
const autoCompleteJS = new autoComplete({
    placeHolder: "Search for stocks...",
    data: {
        src: async (query) => {
          let url = "http://localhost:8080/suggest?search=" + query;
          
          result = [];
          suggestions = await fetch(url)
                          .then(res => res.json())
                          .catch(err => { throw err });
          for (i = 0; i < suggestions.length; ++i) {
            out = suggestions[i];
            element=out.symbol + " - " + out.name;
            result.push({
               key: out.symbol,
               display: element
            });
          }
          return result;
        },
        keys: ["display"],
        cache: false
    },
    resultItem: {
        highlight: true,
    },
    events: {
        input: {
            selection: (event) => {
                const selection = event.detail.selection.value;
                window.location.href = "/stock/" + selection.key
                console.log(selection);
            }
        }
    }
});










var stock = document.getElementById("stock").innerText;

function populateProfile() {
  let url = 'http://localhost:8080/' + stock + "/financials/profile";
  
  fetch(url)
          .then(res => res.json())
          .then(out => {
            document.getElementById("stock-name").innerText = " - " + out.companyName + " (" + out.industry + ", " + out.sector + ")";
            document.getElementById("stock-description").innerHTML = out.description.replaceAll(/\. ([A-Z])/gm, "\.<br\/>$1");
            $("#show-description-link").click(function() {
              $("#stock-description").toggleClass("hidden-element");
            });
          })
          .catch(err => { throw err });
}

function addFlags() {
  let url = 'http://localhost:8080/' + stock + "/financials/flags";
  var flagsDiv = document.getElementById("flags");
  fetch(url)
          .then(res => res.json())
          .then(out => {
              for (elementIndex in out) {
                value = out[elementIndex];
                if (value.type == "RED") {
                    flagsDiv.innerHTML += "&#128308; " + value.text + "<br/>";
                } else if (value.type == "GREEN") {
                    flagsDiv.innerHTML += "&#128994; " + value.text + "<br/>";
                } else if (value.type == "STAR") {
                    flagsDiv.innerHTML += "&#11088; " + value.text + "<br/>";
                } else if (value.type == "YELLOW") {
                    flagsDiv.innerHTML += "&#128992; " + value.text + "<br/>";
                }
              }
          })
          .catch(err => { throw err });
}

var constColorPalette = [
  "rgba(0,0,255,0.3)",
  "rgba(255,0,0,0.3)",
  "rgba(0,255,0,0.3)",
];
var constColorPaletteLine = [
  "rgba(0,0,255,0.8)",
  "rgba(255,0,0,0.8)",
  "rgba(0,255,0,0.8)",
];


function createCheckbox(label) {
  var checkbox = document.createElement("input");
  checkbox.type="checkbox";
  checkbox.innerHtml=label;
  

  return label;
}

function createChart(urlPath, title, chartOptions) {
  var canvas =document.createElement("canvas");
  canvas.style='width:100%;max-height:400px'
  
  var underChartBar = document.createElement("div");
  underChartBar.style="width:100%";
  
  var chartDiv = document.createElement("div");
  chartDiv.className="chartDiv";
  
  var titleDiv = document.createElement("h4");
  titleDiv.innerText = title;
  titleDiv.className="chart-title";
  
  var element = document.getElementById("charts");
  element.appendChild(titleDiv);
  element.appendChild(chartDiv);
  element.appendChild(underChartBar);

  var xValues = [];
  var yValues = [];
  type = chartOptions.type !== undefined ? chartOptions.type : 'line';
  suggestedMin = chartOptions.suggestedMin !== undefined ? chartOptions.suggestedMin : undefined;
  var unit = chartOptions.unit !== undefined ? " " + chartOptions.unit : "";
  var label = chartOptions.label === undefined ? "data" : chartOptions.label;
  var legendDisplay = chartOptions.additionalCharts === undefined ? false : true;
  
  var colorPaletteLine = constColorPaletteLine;
  var colorPalette = constColorPalette;
  
  if (type == "bar") {
    colorPalette = ["rgba(0,0,255,0.6)"];
  }
  
  var chart = new Chart(canvas, {
    type: type,
    data: {
      labels: xValues,
      datasets: [{
        fill: true,
        pointRadius: 2,
        borderColor: colorPaletteLine[0],
        backgroundColor: colorPalette[0],
        data: yValues,
        pointHitRadius: 300,
        label: label
      }]
    }, 
    options: {
      responsive: true,

       label: {
         display: false
       },
      plugins: {
        /*title: {
          display: true,
          text: title
        },*/
        legend: {
          display: legendDisplay
        },
        tooltip: {
            callbacks: {
                label: (item) =>
                    `${item.dataset.label}: ${item.formattedValue}${unit}`,
            },
        },
      },
      scales: {
        x: {
          display: true,
        },
        y: {
          display: true,
          type: 'linear',
          min: chartOptions.suggestedMin,
          max: chartOptions.suggestedMax
        }
      },
    },
  });
  
  
  var button=document.createElement("button");
  button.innerHTML = "Logarithmic";
  button.className="floatleft";
  button.onclick=function() {
      isCurrentlyLinear = chart.options.scales.y.type == 'linear';
      value = (isCurrentlyLinear ? 'logarithmic' : 'linear')
      if (isCurrentlyLinear) {
        button.classList.add("pressed");
      }else {
        button.classList.remove("pressed");
      }
      chart.options.scales.y.type = value;
      chart.update();
  }
  var startAtZeroButton=document.createElement("button");
  startAtZeroButton.innerHTML = "Zero based";
  startAtZeroButton.className="floatleft";
  startAtZeroButton.onclick=function() {
      isCurrentlyEnabled = (chart.options.scales.y.originalMin !== undefined);
      if (isCurrentlyEnabled) {
        startAtZeroButton.classList.remove("pressed");
      } else {
        startAtZeroButton.classList.add("pressed");
      }
      if (isCurrentlyEnabled) {
        chart.options.scales.y.min = chart.options.scales.y.originalMin;
        chart.options.scales.y.max = chart.options.scales.y.originalMax;
        chart.options.scales.y.originalMin = undefined;
        chart.options.scales.y.originalMax = undefined;
      } else {
        chart.options.scales.y.originalMin = chart.options.scales.y.min;
        chart.options.scales.y.originalMax = chart.options.scales.y.max;
        if (chart.options.scales.y.min > 0) {
           chart.options.scales.y.min = 0;
        }
        if (chart.options.scales.y.max < 0) {
          chart.options.scales.y.max = 0;
        }
      }

      chart.update();
  }
  underChartBar.appendChild(button);
  underChartBar.appendChild(startAtZeroButton);

  if (chartOptions.slider !== undefined) {
    var sliderDiv = document.createElement("div")
    var optionSlider = document.createElement("input");
    optionSlider.id=chartOptions.slider.id;
    optionSlider.min = chartOptions.slider.min;
    optionSlider.max = chartOptions.slider.max;
    optionSlider.value = chartOptions.slider.default;
    optionSlider.type="range";
    
    optionSlider.oninput = function() {
    
      let paramedUrl = 'http://localhost:8080/' + stock + urlPath + "?" + chartOptions.slider.parameterName + "=" + this.value;
  
      fetch(paramedUrl)
          .then(res => res.json())
          .then(out => {
                      for (index = 0; index < out.length; index++) {
                          xValues[out.length - index - 1] = out[index].date;
                          yValues[out.length - index - 1] = out[index].value;
                      }
                      chart.update();
          })
          .catch(err => { throw err });
    }
    
    var sliderLabel = document.createElement("label");
    sliderLabel.htmlFor=chartOptions.slider.id;
    sliderLabel.innerText=chartOptions.slider.parameterName;
    
    sliderDiv.appendChild(sliderLabel);
    sliderDiv.appendChild(optionSlider);
    
    underChartBar.appendChild(sliderDiv);
  }
  
  $(underChartBar.lastChild).removeClass("floatleft");
  


  var sliderDiv=document.createElement("div");
  sliderDiv.style="height:300px;position:relative; top: 30px;";
  var slider = $(sliderDiv).slider({
      range: true,
      orientation: "vertical",
      min: 0,
      max: 500,
      values: [ 0, 500 ],
      slide: function( event, ui ) {
          var start = ui.values[0],
          end = ui.values[1];

          chart.options.scales.y.min = start;
          chart.options.scales.y.max = end;
          chart.update();
      }
    });
    $(slider).on("slide", function() {
      var selection = $(this).slider("value");
    });
    chartDiv.appendChild(sliderDiv);
  chartDiv.appendChild(canvas);
  
  
  let url = 'http://localhost:8080/' + stock + urlPath;
  
  fetch(url)
          .then(res => res.json())
          .then(out => {
                      for (index = 0; index < out.length; index++) {
                          xValues[out.length - index - 1] = out[index].date;
                          yValues[out.length - index - 1] = out[index].value;
                      }
                      max = Math.max.apply(Math, yValues);
                      min = Math.min.apply(Math, yValues);
                  
                      minValueToSet = chartOptions.suggestedMin !== undefined ? chartOptions.suggestedMin : min;
                      maxValueToSet = chartOptions.suggestedMax !== undefined ? chartOptions.suggestedMax : max;
                      
                      minValueToSet = minValueToSet < min ? min : minValueToSet;
                      maxValueToSet = maxValueToSet > max ? max : maxValueToSet;
                      
                      if (minValueToSet >= maxValueToSet) {
                         minValueToSet = maxValueToSet + 1.0;
                      }
                  
                      if (!isNaN(minValueToSet)) {
                        slider.slider("option", "min", min);
                        slider.slider('values', 0, minValueToSet);
                        chart.options.scales.y.min = minValueToSet;
                      }
                      if (!isNaN(maxValueToSet)) {
                        slider.slider("option", "max", max);
                        slider.slider('values', 1, maxValueToSet);
                        chart.options.scales.y.max = maxValueToSet;
                      }
                      startAtZeroButton.onclick();
                      chart.update();
          }).then(out => {
                   if (chartOptions.additionalCharts !== undefined && chartOptions.additionalCharts.length > 0) {
                   for (elementIndex in chartOptions.additionalCharts) {
                      var element = chartOptions.additionalCharts[elementIndex];
                      addAdditionalChart(element);
                   }
                }
          })
          .catch(err => { throw err });
    
    
    function addAdditionalChart(element) {
          localUri  = 'http://localhost:8080/' + stock + element.url;
          fetch(localUri)
            .then(res => res.json())
            .then(out => {
                        var newXValues = [];
                        var newYValues = [];
                        for (index = 0; index < out.length; index++) {
                            newXValues[out.length - index - 1] = out[index].date;
                            newYValues[out.length - index - 1] = out[index].value;
                        }
                        max = Math.max.apply(Math, newYValues);
                        min = Math.min.apply(Math, newYValues);
                    
                        minValueToSet = min;
                        maxValueToSet = max;
                    
                        if (chart.options.scales.y.min < minValueToSet) {
                           minValueToSet = chart.options.scales.y.min;
                        }
                        if (chart.options.scales.y.max > maxValueToSet) {
                           maxValueToSet = chart.options.scales.y.max;
                        }

                        
                        if (minValueToSet >= maxValueToSet) {
                           minValueToSet = maxValueToSet + 1.0;
                        }
                        chart.data.datasets.unshift({
                          pointRadius: 2,
                          borderColor: colorPaletteLine[chart.data.datasets.length % colorPalette.length],
                          backgroundColor: colorPalette[chart.data.datasets.length % colorPalette.length],
                          data: newYValues,
                          pointHitRadius: 300,
                          label: element.label
                        });
                    
                        if (!isNaN(minValueToSet)) {
                          slider.slider("option", "min", min);
                          slider.slider('values', 0, minValueToSet);
                          chart.options.scales.y.min = minValueToSet;
                        }
                        if (!isNaN(maxValueToSet)) {
                          slider.slider("option", "max", max);
                          slider.slider('values', 1, maxValueToSet);
                          chart.options.scales.y.max = maxValueToSet;
                        }
                        chart.update();
            })
            .catch(err => { throw err });
    }
    

}

function createSeparator(title) {
  var hrElement =document.createElement("hr");
  var hone = document.createElement("h1");
  
  hone.innerHTML = title;
  
  var element = document.getElementById("charts");
  
  children=Array.from(element.children);
  
  if (children.length > 1) {
    element.appendChild(hrElement);
  }
  element.appendChild(hone);
  
}

populateProfile();

createSeparator("Income");
createChart("/financials/revenue", "Revenue", {label: "Revenue"});
createChart("/financials/net_income", "Net income", {label: "Net income", additionalCharts: [
  {
    "url": "/financials/fcf",
    "label": "FCF"
  },
]});


createChart("/financials/eps", "EPS", {});
createChart("/financials/pfcf", "FCF per share", {});


createSeparator("Margins")
createChart("/financials/gross_margin", "Gross margin", {suggestedMin: -10, unit: '%', label: "Gross margin", additionalCharts: [
  {
    "url": "/financials/operating_margin",
    "label": "Operating margin"
  }
]});
createChart("/financials/net_margin", "Net margin", {suggestedMin: -20, unit: '%'});


createSeparator("Price ratios")
createChart("/financials/pe_ratio", "PE ratio", {suggestedMin: -5, suggestedMax: 50});
createChart("/financials/cape_ratio", "CAPE ratio", {suggestedMin: -5, suggestedMax: 100});
createChart("/financials/past_pe_to_growth_ratio", "Trailing PEG ratio", {suggestedMin: -2, suggestedMax: 5});
createChart("/financials/ev_over_ebitda", "EV over ebitda", {});

createChart("/financials/p2g_ratio", "Price to Book ratio", {suggestedMin: 0, suggestedMax: 15});
createChart("/financials/quick_ratio", "Quick ratio", {suggestedMin: 0, suggestedMax: 5});


createSeparator("Debt information")

createChart("/financials/cash_flow_to_debt", "Operating cash flow debt coverage", {unit: '%'});
createChart("/financials/short_term_coverage_ratio", "Operating cash flow short term debt coverage", {unit: '%'});
createChart("/financials/short_term_assets_to_total_debt", "Short term assets to total debt", {});
createChart("/financials/altmanz", "Altman Z score", {});
createChart("/financials/interest_expense", "Interest expense", {});
createChart("/financials/interest_rate", "Interest rate", {unit: '%'});
createChart("/financials/interest_coverage", "EBIT / interest", {unit: 'x'});



createSeparator("Assets")
createChart("/financials/current_assets", "Current assets vs liabilities", {label: "Current assets", additionalCharts: [
  {
    "url": "/financials/current_liabilities",
    "label": "Current liabilities"
  }
]});
createChart("/financials/total_assets", "Total assets vs liabilities", {label: "Total assets", additionalCharts: [
  {
    "url": "/financials/total_liabilities",
    "label": "Total liabilities"
  }
]});
createChart("/financials/cash", "Cash and cash equivalents", {});

//createChart("/financials/non_current_assets", "Non current assets", {});
//createChart("/financials/long_term_debt", "Long term debt", {});


createSeparator("Return ratios")
createChart("/financials/roic", "Return on invested capital", {unit: '%'});
createChart("/financials/return_on_assets", "Return on assets", {unit: '%'});
createChart("/financials/return_on_tangible_assets", "Return on tangible assets", {unit: '%'});


createSeparator("Yields")
createChart("/financials/eps_yield", "Earnings flow yield", {suggestedMin: -2, suggestedMax: 50, unit: '%', label: "EPS yield", additionalCharts: [
  {
    "url": "/financials/fcf_yield",
    "label": "Free cash flow yield"
  },
  {
    "url": "/financials/fed_rate",
    "label": "FED funds rate"
  }
]});
createChart("/financials/expected_return", "Compsite yield", {unit: '%'});


createSeparator("Other")
createChart("/financials/share_count", "Share count", {});
createChart("/financials/tax_rate", "Tax rate", {});
createChart("/financials/stock_compensation", "Stock compensation", {unit: '%'});
createChart("/financials/stock_compensation_per_net_income", "Stock compensation / net income", {suggestedMin: -2, unit: '%'});
createChart("/financials/stock_compensation_per_net_revenue", "Stock compensation / revenue", {suggestedMin: 0, unit: '%'});
createChart("/financials/stock_compensation_per_market_cap", "Stock compensation / market cap", {suggestedMin: 0, unit: '%'});
createChart("/financials/capex_to_revenue", "CAPEX to revenue", {unit: '%'});
createChart("/financials/pietrosky_score", "Pietrosky score", {});



createSeparator("Dividend")
createChart("/financials/dividend_yield", "Dividend yield", {unit: '%', suggestedMin: -2, suggestedMax: 50});
createChart("/financials/dividend_payout_ratio", "Dividend payout ratio", {unit: '%', suggestedMin: -2, suggestedMax: 150});
createChart("/financials/dividend_payout_ratio_with_fcf", "Dividend payout ratio FCF", {unit: '%', suggestedMin: -2, suggestedMax: 150});
createChart("/financials/dividend_paid", "Dividend paid", {});
createChart("/financials/dividend_yield_per_current_price", "Dividend yield for invest price", {unit: '%', suggestedMin: -2, suggestedMax: 200});



createSeparator("Growth")
createChart("/financials/eps_growth_rate", "EPS growth annual", {type: 'bar', unit: '%'});
createChart("/financials/eps_growth_rate_7yr_moving_avg", "EPS annual growth x year intervals", {
  type: 'bar',
  unit: '%',
  slider: {
    id: "eps_growth_year_slider",
    parameterName: "year",
    min: 2,
    max: 10,
    default: 7
}});

createChart("/financials/fcf_growth_rate", "FCF growth annual", {type: 'bar', unit: '%'});
createChart("/financials/fcf_growth_rate_7yr_moving_avg", "FCF annual growth x year intervals", {
  type: 'bar',
  unit: '%',
  slider: {
    id: "fcf_growth_year_slider",
    parameterName: "year",
    min: 2,
    max: 10,
    default: 7
}});

createChart("/financials/revenue_growth_rate", "Revenue growth annual", {type: 'bar', unit: '%'});
createChart("/financials/share_count_growth_rate", "Share count growth annual", {type: 'bar', unit: '%'});
createChart("/financials/dividend_growth_rate", "Dividend growth annual", {type: 'bar', unit: '%'});



createSeparator("DCF")
createChart("/financials/eps_dcf", "EPS DCF", {});
createChart("/financials/fcf_dcf", "FCF DCF", {});
createChart("/financials/dividend_dcf", "Dividend DCF", {});
createChart("/financials/cash_per_share", "Cash per share", {});
createChart("/financials/graham_number", "Graham number", {});
createChart("/financials/revenue_projection", "Revenue projection stock price", {});


createSeparator("Price")
createChart("/financials/price", "Price", {label: "price", additionalCharts: [
  {
    "url": "/financials/composite_fair_value",
    "label": "Composite fair value"
  }
]});
createChart("/financials/price_growth_rate", "Price growth", {type: 'bar'});

addFlags();

</script>

</body>
</html>
